WITH raw AS (
  SELECT
    to_timestamp(date / 1000) AS ts,
    value::jsonb AS alarms
  FROM variable_log_string
  WHERE id_var = 447
    AND value IS NOT NULL
    AND value <> '[]'
),

flattened AS (
  SELECT
    ts,
    alarm_elem->0 AS alarm_code,
    alarm_elem->1 AS alarm_text,
    alarm_elem->2 AS alarm_state,
    alarm_elem->3 AS alarm_severity
  FROM raw
  CROSS JOIN LATERAL jsonb_array_elements(alarms) AS alarm_elem
)

SELECT
  ts,
  alarm_code,
  alarm_text,
  alarm_state,
  alarm_severity
FROM flattened
ORDER BY ts
LIMIT 200;
