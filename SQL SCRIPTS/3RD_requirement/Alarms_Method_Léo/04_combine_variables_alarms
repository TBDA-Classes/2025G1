-- 1) Alarm messages from id_var = 447
WITH msg_alarms AS (
  SELECT
    to_timestamp(date / 1000) AS ts,
    'MSG_447'::text AS source,
    value::jsonb AS raw_json
  FROM variable_log_string
  WHERE id_var = 447
    AND value IS NOT NULL
    AND value <> '[]'
),

-- 2) Alarm / stop flags from float variables
flag_alarms AS (
  SELECT to_timestamp(date / 1000) AS ts, 'FLAG_540_EMERGENCY' AS source
  FROM variable_log_float
  WHERE id_var = 540 AND value <> 0

  UNION ALL
  SELECT to_timestamp(date / 1000), 'FLAG_660_STOP_ACTIVE'
  FROM variable_log_float
  WHERE id_var = 660 AND value <> 0

  UNION ALL
  SELECT to_timestamp(date / 1000), 'FLAG_636_ALARM_ACTIVE'
  FROM variable_log_float
  WHERE id_var = 636 AND value <> 0

  UNION ALL
  SELECT to_timestamp(date / 1000), 'FLAG_552_PROG_STOPPED'
  FROM variable_log_float
  WHERE id_var = 552 AND value <> 0

  UNION ALL
  SELECT to_timestamp(date / 1000), 'FLAG_575_PROG_RUN'
  FROM variable_log_float
  WHERE id_var = 575 AND value <> 0
),

-- 3) Combine everything
all_alarms AS (
  SELECT ts, source FROM msg_alarms
  UNION ALL
  SELECT ts, source FROM flag_alarms
)

SELECT
  ts,
  ARRAY_AGG(source ORDER BY source) AS alarm_sources
FROM all_alarms
GROUP BY ts
ORDER BY ts
LIMIT 200;
