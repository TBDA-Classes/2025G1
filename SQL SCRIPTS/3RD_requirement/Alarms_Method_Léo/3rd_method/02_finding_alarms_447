WITH alarm_snapshots AS (
    -- All snapshots of ALARMS (id = 447)
    SELECT
        to_timestamp(date/1000) AS ts,
        value
    FROM variable_log_string
    WHERE id_var = 447
    ORDER BY ts
),

snapshots_with_next AS (
    -- Add next timestamp
    SELECT
        ts,
        value,
        LEAD(ts) OVER (ORDER BY ts) AS next_ts
    FROM alarm_snapshots
),

alarms_flat AS (
    -- Expand alarm list from each snapshot
    SELECT
        s.ts,
        s.next_ts,
        ROW_NUMBER() OVER (PARTITION BY s.ts) AS alarm_index_in_list,
        (m)[1] AS alarm_code,
        (m)[2] AS alarm_text,
        (m)[3]::int AS field_3,
        (m)[4]::int AS field_4,
        (m)[5]::bigint AS field_5
    FROM snapshots_with_next s
    CROSS JOIN LATERAL regexp_matches(
        s.value,
        '\["([^"]+)","([^"]+)",([0-9]+),([0-9]+),([0-9]+)\]',
        'g'
    ) AS m
    WHERE s.next_ts IS NOT NULL
),

segments AS (
    -- raw active intervals
    SELECT
        alarm_code,
        alarm_text,
        field_3, field_4, field_5,
        ts,
        next_ts,
        LAG(next_ts) OVER (
            PARTITION BY alarm_code, alarm_text
            ORDER BY ts
        ) AS prev_end
    FROM alarms_flat
),

marked AS (
    -- new alarm period (gap between two segments)
    SELECT
        *,
        CASE
            WHEN prev_end IS NULL OR prev_end < ts THEN 1 ELSE 0
        END AS is_new_group
    FROM segments
),

islands AS (
    -- group continuous alarm intervals
    SELECT
        *,
        SUM(is_new_group) OVER (
            PARTITION BY alarm_code, alarm_text
            ORDER BY ts
        ) AS grp
    FROM marked
),

alarm_periods AS (
    -- aggregate into final periods
    SELECT
        alarm_code,
        alarm_text,
        field_3,
        field_4,
        field_5,
        MIN(ts) AS start_time,
        MAX(next_ts) AS end_time
    FROM islands
    GROUP BY alarm_code, alarm_text, field_3, field_4, field_5, grp
)

SELECT
    start_time,
    end_time,
    end_time - start_time AS duration,
    alarm_code,
    alarm_text,
    field_3,
    field_4,
    field_5
FROM alarm_periods
ORDER BY start_time, alarm_code;
