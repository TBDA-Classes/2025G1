--Now, we'll filter to identify only true outages, that is, when a certain amount of time has elapsed between two log entries.
--For example: a gap of more than 5 minutes (300 seconds).

SELECT *
FROM (
  SELECT
    id_var,
    to_timestamp(date / 1000) AS log_time,
    value AS message,
    LAG(to_timestamp(date / 1000)) OVER (PARTITION BY id_var ORDER BY date) AS previous_log_time,
    ROUND(EXTRACT(EPOCH FROM (to_timestamp(date / 1000) -
                              LAG(to_timestamp(date / 1000)) OVER (PARTITION BY id_var ORDER BY date))) / 60, 2) AS minutes_since_last_log
  FROM variable_log_string
  WHERE id_var = 447
    AND value IS NOT NULL
    AND value <> '[]'
) sub
WHERE minutes_since_last_log > 5
ORDER BY log_time ASC;

--results : stops for more than 5 minutes

--if the messages don't appear with the previous code we can use :

SELECT
  to_timestamp(date / 1000) AS log_time,
  LEFT(value, 150) AS message_preview,
  ROUND(EXTRACT(EPOCH FROM (to_timestamp(date / 1000) -
                            LAG(to_timestamp(date / 1000)) OVER (ORDER BY date))) / 60, 2) AS minutes_since_last_log
FROM variable_log_string
WHERE id_var = 447
  AND value IS NOT NULL
  AND value <> '[]'
ORDER BY date ASC
LIMIT 50;
