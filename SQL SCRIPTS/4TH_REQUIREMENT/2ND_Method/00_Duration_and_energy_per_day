
WITH s AS (
  SELECT
      to_timestamp(l.date / 1000.0)         AS ts,
      GREATEST(LEAST(l.value::float,100),0) AS pct
  FROM variable_log_float l
  JOIN variable v ON v.id = l.id_var
  WHERE v.name = 'MANDRINO_CONSUMO_VISUALIZADO'
    AND l.value = l.value
),
o AS (
  SELECT
      ts,
      LEAD(ts) OVER (ORDER BY ts) AS ts_next,
      pct
  FROM s
),
iv AS (
  -- On ne garde que les intervalles valides
  SELECT ts, ts_next, pct
  FROM o
  WHERE ts_next IS NOT NULL AND ts_next > ts
),
-- DÃ©coupe chaque intervalle par jour avec generate_series
split AS (
  SELECT
    (gs)::timestamp                AS day_start,
    LEAST(ts_next, gs + interval '1 day') AS seg_end,
    GREATEST(ts, gs)               AS seg_start,
    pct
  FROM iv
  JOIN LATERAL generate_series(
          date_trunc('day', ts),
          date_trunc('day', ts_next),
          interval '1 day'
       ) AS gs ON TRUE
  WHERE ts_next > ts
)
SELECT
  day_start::date                              AS day,
  SUM(EXTRACT(EPOCH FROM (seg_end - seg_start))/3600.0)                AS total_duration_h,
  SUM((pct/100.0) * 15 * EXTRACT(EPOCH FROM (seg_end - seg_start))/3600.0) AS total_energy_kWh
FROM split
GROUP BY day
ORDER BY day;
