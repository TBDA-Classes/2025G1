-- This script calculates the number of distinct variables that recorded data for each second within the specified timeframe 
--(Jan 4, 2021, 06:00-22:00). It then counts how many seconds had a specific number of active variables (e.g., how many seconds 
-- had 5 distinct variables active, how many had 10, etc.), generating a frequency distribution table. The purpose is to analyze 
-- this distribution to find data-driven thresholds for classifying the machine into Idle, Intermediate, and Active states based on how many different systems are operating concurrently

WITH VariablesPerSecond AS (
    -- 1. For each second, get a list of all distinct variables that recorded a value on March 18, 2021.
        SELECT
                to_timestamp(floor(CAST(date AS BIGINT) / 1000)) AS timestamp,
                        id_var
                            FROM
                                    public.variable_log_float
                                        WHERE
                                                -- Analyze March 18, 2021, from 06:00 to 22:00
                                                        to_timestamp(CAST(date AS BIGINT) / 1000) BETWEEN '2021-03-18 06:00:00' AND '2021-03-18 22:00:00'
                                                            GROUP BY
                                                                    timestamp, id_var -- Ensure we only count each variable once per second
                                                                    ),
                                                                    DistinctCountPerSecond AS (
                                                                        -- 2. Count how many distinct variables were active each second.
                                                                            SELECT
                                                                                    timestamp,
                                                                                            COUNT(id_var) AS distinct_vars_count
                                                                                                FROM
                                                                                                        VariablesPerSecond
                                                                                                            GROUP BY
                                                                                                                    timestamp
                                                                                                                    )
                                                                                                                    -- 3. Count the occurrences (number of seconds) for each distinct variable count.
                                                                                                                    SELECT
                                                                                                                        distinct_vars_count,
                                                                                                                            COUNT(*) AS number_of_seconds
                                                                                                                            FROM
                                                                                                                                DistinctCountPerSecond
                                                                                                                                GROUP BY
                                                                                                                                    distinct_vars_count
                                                                                                                                    ORDER BY
                                                                                                                                        distinct_vars_count DESC;