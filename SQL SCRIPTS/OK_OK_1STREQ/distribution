-- PURPOSE: Get a smoothed list of active variable counts for K-Means/Otsu analysis,
-- using the 5 "average" sample days (full 24-hour periods) to find unbiased thresholds.
-- METHODOLOGY: Applies a 15-second moving average to the per-second distinct count.

WITH RawSignal AS (
    -- 1. Get the count of distinct variables per second ONLY for the 5 sample days.
    SELECT
        to_timestamp(floor(CAST(date AS BIGINT) / 1000)) AS timestamp,
        COUNT(DISTINCT id_var) AS distinct_vars_count
    FROM
        public.variable_log_float
    WHERE
        -- Filter for the 5 selected average days
        date(to_timestamp(floor(CAST(date AS BIGINT) / 1000))) IN (
            '2022-01-07',
            '2021-10-27',
            '2022-02-02',
            '2021-07-07',
            '2021-11-26'
        )
        -- We analyze the full 24 hours to get unbiased thresholds
    GROUP BY
        timestamp
),
SmoothedSignal AS (
    -- 2. Apply the 15-second moving average to smooth the signal.
    -- We use PARTITION BY to restart the average for each day, avoiding spillover.
    SELECT
        timestamp,
        AVG(distinct_vars_count) OVER (
            PARTITION BY date(timestamp) -- Restart average calculation for each new day
            ORDER BY timestamp
            ROWS BETWEEN 14 PRECEDING AND CURRENT ROW -- 15-second trailing window
        ) AS smoothed_count,
        -- We also need to know how many records to skip per day
        ROW_NUMBER() OVER (PARTITION BY date(timestamp) ORDER BY timestamp) as row_num_per_day
    FROM
        RawSignal
)
-- 3. Select the smoothed data for export.
-- We skip the first 14 seconds of EACH day as their average is incomplete.
SELECT
    smoothed_count AS distinct_vars_count -- Rename column for the Python script
FROM
    SmoothedSignal
WHERE
    row_num_per_day > 14; -- Skip the incomplete averages at the start of each day
    row_num_per_day > 14; -- Skip the 
