-- PURPOSE: Calculate TOTAL time in 4 states (True Idle, Low, Intermediate, High) across the ENTIRE dataset. (Simplified & Corrected Logic)
-- METHODOLOGY: 1. Calculate "True Idle" by summing all gaps (> 1s) between active seconds.
--              2. Calculate "Active States" (Low/Med/High) by classifying all non-gap seconds using the 15s moving average and validated thresholds.

WITH RawSignal AS (
    -- 1. Get all active seconds and their raw count
    SELECT
        to_timestamp(floor(CAST(date AS BIGINT) / 1000)) AS timestamp,
        COUNT(DISTINCT id_var) AS distinct_vars_count
    FROM
        public.variable_log_float
    GROUP BY
        timestamp
),
IdleGaps AS (
    -- 2. Calculate the total duration of all "True Idle (Off)" gaps
    -- This CTE calculates the time for the *first* state.
    SELECT
        'True Idle (Off)' AS state,
        SUM(gap_duration) as total_duration
    FROM (
        SELECT
            -- A gap is the time between this timestamp and the previous one
            timestamp - (LAG(timestamp) OVER (ORDER BY timestamp) + interval '1 second') AS gap_duration
        FROM
            RawSignal
    ) AS Gaps
    WHERE
        gap_duration > interval '0 seconds' -- Filter for actual gaps
),
SmoothedSignal AS (
    -- 3. Apply the 15-second moving average ONLY to the active seconds
    SELECT
        timestamp,
        AVG(distinct_vars_count) OVER (
            PARTITION BY date(timestamp) -- Restart average for each new day
            ORDER BY timestamp
            ROWS BETWEEN 14 PRECEDING AND CURRENT ROW
        ) AS smoothed_count,
        ROW_NUMBER() OVER (PARTITION BY date(timestamp) ORDER BY timestamp) as row_num_per_day
    FROM
        RawSignal
),
ActiveStateTotals AS (
    -- 4. Classify each active second and SUM the totals
    -- This CTE calculates the time for the *other three* states.
    SELECT
        CASE
            WHEN smoothed_count <= 14 THEN 'Low Activity'
            WHEN smoothed_count <= 20 THEN 'Intermediate Activity'
            ELSE 'High Activity'
        END AS state,
        COUNT(*) * interval '1 second' as total_duration
    FROM
        SmoothedSignal
    WHERE
        row_num_per_day > 14 -- Skip incomplete averages at the start of each day
    GROUP BY
        state
)
-- 5. Combine the results
SELECT * FROM IdleGaps
UNION ALL
SELECT * FROM ActiveStateTotals;
