/* Classify alerts (ALARMS + EASY_LOG_MESSAGE) and tie them to program runs */

WITH params AS (SELECT 30::int AS topN),

days AS (
  SELECT day
  FROM v_interesting_days
  ORDER BY interesting_score DESC NULLS LAST, day DESC
  LIMIT (SELECT topN FROM params)
),


prog_state_raw AS (
  SELECT ts_utc, (ts_utc)::date AS day, value::int AS state
  FROM v_log_float WHERE id_var = 828 AND value IN (0,1)
  UNION ALL
  SELECT ts_utc, (ts_utc)::date AS day, value::int AS state
  FROM v_log_float WHERE id_var = 575 AND value IN (0,1)
),
prog_state AS (
  SELECT ts_utc, day, CASE WHEN SUM(state)>0 THEN 1 ELSE 0 END AS state
  FROM prog_state_raw GROUP BY ts_utc, day
),
ordered AS (
  SELECT p.ts_utc, p.day, p.state,
         LEAD(p.ts_utc) OVER (ORDER BY p.ts_utc) AS next_ts
  FROM prog_state p JOIN days d ON d.day = p.day
),
runs AS (
  SELECT day,
         ts_utc AS start_ts,
         LEAST(next_ts, date_trunc('day', ts_utc) + INTERVAL '1 day') AS end_ts
  FROM ordered
  WHERE state = 1 AND next_ts IS NOT NULL
),


str_logs AS (
  SELECT s.ts_utc, s.ts_utc::date AS day, v.name AS var_name, s.value::text AS msg
  FROM v_log_string s
  JOIN variable v ON v.id = s.id_var
  JOIN days d ON d.day = s.ts_utc::date
  WHERE v.name IN ('ALARMS','EASY_LOG_MESSAGE')
),

classified AS (
  SELECT
    day, ts_utc, var_name, msg,
    CASE
      WHEN msg ~* '(overheat|surchauff|temperat|sobrecalent)'                     THEN 'THERMAL'
      WHEN msg ~* '(power|voltage|tension|voltaje|energia|corriente)'             THEN 'POWER'
      WHEN msg ~* '(door|guard|safety|seguridad|porta|puerta|interlock)'          THEN 'SAFETY'
      WHEN msg ~* '(stop|stopped|parada|arresto|emergency|e-stop|emergencia)'     THEN 'STOP'
      WHEN msg ~* '(error|fault|fail|alarm|alarma|allarme|anomalia)'              THEN 'GENERIC_ALARM'
      ELSE 'OTHER'
    END AS alert_type,
    COALESCE(
      (regexp_match(msg, '(?:ZONE|ZONA)[ _-]?([0-9]+)'))[1],
      (regexp_match(msg, '(?:CONVEYOR|TRANSPORTADOR)[ _-]?([0-9]+)'))[1],
      (regexp_match(msg, '(?:SPINDLE|MANDRINO|HUSILLO)[ _-]?([0-9]+)'))[1],
      (regexp_match(msg, '(?:AXIS|EJE)[ _-]?([A-Z0-9]+)'))[1],
      (regexp_match(var_name, '(?:ZONE|ZONA)[ _-]?([0-9]+)'))[1],
      (regexp_match(var_name, '(?:CONVEYOR|TRANSPORTADOR)[ _-]?([0-9]+)'))[1],
      (regexp_match(var_name, '(?:SPINDLE|MANDRINO|HUSILLO)[ _-]?([0-9]+)'))[1],
      (regexp_match(var_name, '(?:AXIS|EJE)[ _-]?([A-Z0-9]+)'))[1]
    ) AS location_token
  FROM str_logs
),


alerts_in_runs AS (
  SELECT
    c.day, c.ts_utc, c.alert_type, COALESCE(c.location_token,'UNK') AS location,
    r.start_ts, r.end_ts
  FROM classified c
  LEFT JOIN runs r
    ON r.day = c.day
   AND c.ts_utc >= r.start_ts AND c.ts_utc <= r.end_ts
)

SELECT
  day,
  alert_type,
  location,
  COUNT(*)                                   AS events_total,
  COUNT(*) FILTER (WHERE start_ts IS NOT NULL) AS events_during_program
FROM alerts_in_runs
GROUP BY day, alert_type, location
ORDER BY day, alert_type, location;
